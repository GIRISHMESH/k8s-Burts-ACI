trigger:
  - main

variables:
  ACR_NAME: acrforaksdemo2
  IMAGE_NAME: app1/kube-nginx-acr
  IMAGE_TAG: $(Build.BuildId)   # auto-generated unique tag

stages:
- stage: Build
  jobs:
  - job: BuildAndPush
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: Docker@2
        displayName: Build and Push Docker Image
        inputs:
          command: buildAndPush
          repository: $(IMAGE_NAME)
          dockerfile: Dockerfile
          containerRegistry: $(ACR_SERVICE_CONNECTION)   # <-- Service connection to ACR
          tags: |
            $(IMAGE_TAG)

- stage: Deploy
  jobs:
  - job: DeployToAKS
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: KubernetesManifest@1
        displayName: Deploy to AKS
        inputs:
          action: deploy
          kubernetesServiceConnection: $(AKS_SERVICE_CONNECTION)
          namespace: nginx-stack
          manifests: |
            k8s-manifests/*.yaml
          containers: |
            $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)
          imagePullSecrets: |
            $(imagePullSecret)



